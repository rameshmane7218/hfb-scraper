<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Scrapper</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="selectorMode.css" id="selectorMode" />

    <style>
      .selectorBox {
        max-width: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      /* #formData {
        display: none;
      } */
    </style>
  </head>
  <body>
    <h1>Data Scrapper</h1>
    <div>
      <div>
        <div>
          <p>klfsadjkl</p>
          <img
            src="https://onemg.gumlet.io/images/c_fit,h_150,w_150,f_auto,q_auto/q9xnukhrycqpcypv7aeg/tata-1mg-apple-cider-vinegar-probiotic-plus-raw-unfiltered-unpasteurized-with-the-mother.jpg"
            alt="pic"
          />
          <span>Span Tag</span>
          <!-- <p>prize: 3999</p> -->
          <div>
            <ul>
              <li>list 1</li>
              <li>list 2</li>
              <li>list 3</li>
              <li>list 4</li>
            </ul>
          </div>
        </div>
        <div>
          <p>klfsadjkl</p>
          <img
            src="https://onemg.gumlet.io/images/c_fit,h_150,w_150,f_auto,q_auto/q9xnukhrycqpcypv7aeg/tata-1mg-apple-cider-vinegar-probiotic-plus-raw-unfiltered-unpasteurized-with-the-mother.jpg"
            alt="pic"
          />
          <span>Span Tag</span>
          <p>prize: 3999</p>
          <div>
            <ul>
              <li>list 1</li>
              <li>list 2</li>
              <li>list 3</li>
              <li>list 4</li>
            </ul>
          </div>
        </div>
        <div>
          <p>klfsadjkl</p>
          <img
            src="https://onemg.gumlet.io/images/c_fit,h_150,w_150,f_auto,q_auto/q9xnukhrycqpcypv7aeg/tata-1mg-apple-cider-vinegar-probiotic-plus-raw-unfiltered-unpasteurized-with-the-mother.jpg"
            alt="pic"
          />
          <span>Span Tag</span>
          <p>prize: 3999</p>
          <div>
            <ul>
              <li>list 1</li>
              <li>list 2</li>
              <li>list 3</li>
              <li>list 4</li>
            </ul>
          </div>
        </div>
        <div>
          <p>klfsadjkl</p>
          <img
            src="https://onemg.gumlet.io/images/c_fit,h_150,w_150,f_auto,q_auto/q9xnukhrycqpcypv7aeg/tata-1mg-apple-cider-vinegar-probiotic-plus-raw-unfiltered-unpasteurized-with-the-mother.jpg"
            alt="pic"
          />
          <span>Span Tag</span>
          <p>prize: 3999</p>
          <div>
            <ul>
              <li>list 1</li>
              <li>list 2</li>
              <li>list 3</li>
              <li>list 4</li>
            </ul>
          </div>
        </div>
        <div>
          <p>klfsadjkl</p>
          <img
            src="https://onemg.gumlet.io/images/c_fit,h_150,w_150,f_auto,q_auto/q9xnukhrycqpcypv7aeg/tata-1mg-apple-cider-vinegar-probiotic-plus-raw-unfiltered-unpasteurized-with-the-mother.jpg"
            alt="pic"
          />
          <span>Span Tag</span>
          <p>prize: 3999</p>
          <div>
            <ul>
              <li>list 1</li>
              <li>list 2</li>
              <li>list 3</li>
              <li>list 4</li>
            </ul>
          </div>
        </div>
      </div>
      <br />
      <a href="https://javascript.info/searching-elements-dom" target="_blank"
        >link</a
      >
      <br />
      <br />
    </div>
    <div id="selectedKeys">
      <p id="pageUrl"></p>
      <table>
        <thead>
          <tr>
            <td>Id</td>
            <td>Type</td>
            <td>Selector</td>
          </tr>
        </thead>
        <tbody id="selectedKeysbody"></tbody>
      </table>
    </div>

    <div>
      <button onclick="addNewSelector()" id="addNewSelector">
        Add New Selector
      </button>
    </div>
    <form onsubmit="handleOnSubmit(event)" id="formData">
      <label for="">Page Url</label>
      <input type="url" name="link" id="link" placeholder="Page Url" />
      <br />
      <label for="">KeyName</label>
      <input type="text" name="name" id="name" placeholder="name" />
      <br />
      <label for="">Type</label>
      <select name="type" id="type" placeholder="name">
        <option value="text">text</option>
        <option value="image">image</option>
        <option value="link">link</option>
        <option value="html">html</option>
      </select>
      <br />
      <label for="">Css selector</label>
      <input
        type="checkbox"
        name="selector"
        id="selector"
        defaultValue="false"
      />
      <label for="">Multiple select</label>
      <input type="checkbox" name="multiple" id="multiple" />
      <input type="submit" />
      <button type="reset" onclick="cancelAddNewSelector()">Cancel</button>
    </form>

    <div>
      <button id="scrapData" onclick="scrapData()">Scrap Data</button>
    </div>
  </body>
</html>

<script>
  function disableLink() {
    document.querySelector("a").onclick = function () {
      return false;
    };
  }
  // disableLink();
  const Tbody = document.getElementById("selectedKeysbody");
  const pageUrlTag = document.getElementById("pageUrl");
  let dataObj = JSON.parse(localStorage.getItem("keysData")) || {};
  // appendData(details);
  let handleOnSelector = document.getElementById("selector");
  let handleMultiple = document.getElementById("multiple");
  let multipleElement = false;
  let selectedElementSelector = [];
  let selectorMode = false;

  function addNewSelector() {
    const form = document.getElementById("formData");
    // form.style.display = "block";
  }
  function cancelAddNewSelector() {
    const form = document.getElementById("formData");
    form.reset();
    // form.style.display = "none";
  }

  handleOnSelector.onchange = function (event) {
    console.log(event.target.checked);
    if (event.target.checked) {
      document.getElementById("selectorMode").disabled = false;
      disableLink();
      // selectElement(event.target.checked);
      let classSelector = [];
      selectorMode = true;
      turnOnSelector(classSelector);
    } else {
      document.getElementById("selectorMode").disabled = true;
      // selectElement(false);
      turnOnSelector(false);
      selectorMode = false;
    }
  };
  window.onload = function () {
    document.getElementById("selectorMode").disabled = true;
    // selectElement(false);
  };

  handleMultiple.onclick = function (e) {
    if (e.target.checked) {
      multipleElement = true;
    } else {
      multipleElement = false;
    }
  };

  function indexOf(element) {
    var parent = element.parentNode;
    var child,
      index = 1;
    for (
      child = parent.firstElementChild;
      child;
      child = child.nextElementSibling
    ) {
      if (child === element) {
        return index;
      }
      ++index;
    }
    return -1;
  }
  function selectElement(checked) {
    // console.log("selected ", checked);

    let currentValue = checked;
    if (currentValue == false) {
      return false;
    }
    if (currentValue === true) {
      document.body.onmouseover =
        currentValue &&
        function (e) {
          let ele = e.target;

          ele.onmouseover = function (ele) {
            if (ele.target !== ele.currentTarget) {
              return;
            }

            let element = ele.currentTarget;
            element.classList.add("-sitemap-select-item-hover");
            // console.log("currentTarget", element);
          };

          ele.onmouseout = function (ele) {
            if (ele.target !== ele.currentTarget) {
              return;
            }

            let element = ele.currentTarget;
            element.classList.remove("-sitemap-select-item-hover");
            // console.log("currentTarget", element);
          };
        };
    }
  }
  function turnOnSelector(classSelector) {
    // console.log("classSelector1", classSelector);
    let documentDiv = document;
    if (!selectorMode) {
      return;
    }
    documentDiv.onclick =
      selectorMode &&
      function (e) {
        // console.log("element", selectorMode, e);
        // let ans = cssPath(e.target);
        // console.log("ans", ans);

        if (document.getElementById("selector").target == e.target)
          return;
        var element = e.target;
        var selector = element.tagName + ":nth-child(" + indexOf(element) + ")";
        while ((element = element.parentElement) != null) {
          if (element.tagName === "body") {
            selector = "body > " + selector;
            break;
          }
          selector =
            element.tagName +
            ":nth-child(" +
            indexOf(element) +
            ") > " +
            selector;
        }
        console.log("selector: " + selector);
        if (!multipleElement) {
          selectedElementSelector.push(selector);
        } else {
          classSelector.push(selector);
          let commonSelector = getCommonSelector(classSelector);
        }
        // console.log("classSelector2", classSelector);
      };
  }
  function getCommonSelector(arr) {
    if (arr.length >= 2) {
      const [element1, element2] = arr.map((el) =>
        el
          .trim()
          .split(">")
          .map((ele) => ele.trim())
      );

      if (element1.length !== element2.length) {
        alert("Different type element selection is disabled/ not allowed");
        arr.length = 0;
        return false;
      }
      let count = 0;
      for (let i = 0; i < element1.length; i++) {
        // console.log("el : ", element1[i] + "==" + element2[i]);
        if (element1[i] !== element2[i]) {
          count++;
          element1[i] = element1[i].split(":").shift() + "@";
        }
      }
      if (count > 1) {
        alert("Different type element selection is disabled/ not allowed");
        arr.length = 0;
        return false;
      } else {
        // console.log("final selector", element1.join(">"));
        selectedElementSelector = [element1.join(">")];
      }

      // console.log("element", element1, element2);
    }
  }
  var cssPath = function (el) {
    if (!(el instanceof Element)) return;
    var path = [];
    while (el.nodeType === Node.ELEMENT_NODE) {
      var selector = el.nodeName.toLowerCase();
      if (el.id) {
        selector += "#" + el.id;
      } else {
        var sib = el,
          nth = 1;
        while (
          sib.nodeType === Node.ELEMENT_NODE &&
          (sib = sib.previousSibling) &&
          nth++
        );
        selector += ":nth-child(" + nth + ")";
      }
      path.unshift(selector);
      el = el.parentNode;
    }
    return path.join(" > ");
  };

  function handleOnSubmit(event) {
    event.preventDefault();
    const form = document.getElementById("formData");
    const pageLink = form.link.value;
    const name = form.name.value;
    const type = form.type.value;

    const currData = {
      name: name,
      type: type,
      selector: selectedElementSelector[0],
      multiple: multipleElement,
    };
    if (dataObj["pageLink"] == undefined) {
      dataObj["pageLink"] = pageLink;
    }
    if (dataObj["data"] == undefined) {
      dataObj["data"] = [currData];
    } else {
      let preData = dataObj["data"];
      preData.push(currData);
      dataObj["data"] = preData;
    }
    form.reset();
    appendData(dataObj);
    localStorage.setItem("keysData", JSON.stringify(dataObj));
    console.log("Someone clicked me on new tab", dataObj);
  }

  function scrapData() {
    console.log("Someone clicked me", dataObj);
    axios
      .post("http://localhost:8080/scrapper", dataObj)
      .then((res) => {
        console.log(res.data.message);
        console.log(res.data.data);
      })
      .catch((err) => {
        console.log(err);
      });
  }

  function appendData(details) {
    // console.log(details);
    // console.log(details.data);
    let arrayData = details.data;
    Tbody.innerHTML = null;
    pageUrlTag.innerText = null;
    pageUrlTag.innerText = details["pageLink"];

    arrayData.map((el, i) => {
      let tr = document.createElement("tr");
      let id = document.createElement("td");
      id.innerText = el.name;
      let type = document.createElement("td");
      type.innerText = el.type;
      let selector = document.createElement("td");
      selector.setAttribute("class", "selectorBox");
      selector.innerText = el.selector;

      tr.append(id, type, selector);

      Tbody.append(tr);
    });
  }
</script>
